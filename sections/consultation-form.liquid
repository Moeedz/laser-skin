{% comment %}
  Consultation Request Form Section
  - Priority response guarantee banner
  - Conditional fields based on contact method selection:
    - Email: shows email field + info note
    - WhatsApp: shows sub-question (You contact us / We contact you)
      - You contact us: shows WhatsApp button
      - We contact you: shows phone number field
    - Call: shows phone number field
  - Fully customizable from section settings
{% endcomment %}

<style>
  .consultation-form-section {
    max-width: {{ section.settings.section_width }}px;
    margin: 0 auto;
    padding: {{ section.settings.section_padding_top }}px {{ section.settings.section_padding_side }}px {{ section.settings.section_padding_bottom }}px;
    background-color: {{ section.settings.section_background }};
  }

  .consultation-form-container {
    max-width: {{ section.settings.form_max_width }}px;
    margin: 0 auto;
    background: {{ section.settings.form_background }};
    border-radius: {{ section.settings.form_border_radius }}px;
    padding: {{ section.settings.form_padding }}px;
    box-shadow: {{ section.settings.form_shadow }};
  }

  /* Priority Banner */
  .cf-priority-banner {
    text-align: center;
    margin-bottom: 28px;
    padding-bottom: 0;
  }

  .cf-priority-banner-text {
    font-size: {{ section.settings.banner_font_size }}px;
    color: {{ section.settings.banner_text_color }};
    letter-spacing: 0.2px;
  }

  .cf-priority-banner-text strong {
    color: {{ section.settings.banner_highlight_color }};
    font-weight: 600;
    font-style: italic;
  }

  /* Form Heading */
  .cf-heading {
    font-size: {{ section.settings.heading_font_size }}px;
    font-weight: {{ section.settings.heading_font_weight }};
    color: {{ section.settings.heading_color }};
    margin: 0 0 8px 0;
    line-height: 1.3;
    text-align: center;
  }

  .cf-subheading {
    font-size: {{ section.settings.subheading_font_size }}px;
    color: {{ section.settings.subheading_color }};
    text-align: center;
    margin: 0 0 32px 0;
    line-height: 1.5;
  }

  /* Form Groups */
  .cf-group {
    margin-bottom: 24px;
  }

  .cf-label {
    display: block;
    font-size: {{ section.settings.label_font_size }}px;
    font-weight: {{ section.settings.label_font_weight }};
    color: {{ section.settings.label_color }};
    margin-bottom: 10px;
  }

  /* Input Styles */
  .cf-input,
  .cf-textarea {
    width: 100%;
    padding: 14px 18px;
    font-size: {{ section.settings.input_font_size }}px;
    color: {{ section.settings.input_text_color }};
    background: {{ section.settings.input_background }};
    border: {{ section.settings.input_border_width }}px solid {{ section.settings.input_border_color }};
    border-radius: {{ section.settings.input_border_radius }}px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    font-family: inherit;
    box-sizing: border-box;
  }

  .cf-input:focus,
  .cf-textarea:focus {
    outline: none;
    border-color: {{ section.settings.input_focus_border_color }};
    box-shadow: 0 0 0 3px {{ section.settings.input_focus_shadow_color }};
  }

  .cf-input::placeholder,
  .cf-textarea::placeholder {
    color: {{ section.settings.input_placeholder_color }};
  }

  .cf-input-preselected {
    background: {{ section.settings.preselected_background }};
    color: {{ section.settings.preselected_text_color }};
    cursor: default;
  }

  .cf-textarea {
    min-height: 100px;
    resize: vertical;
    line-height: 1.5;
  }

  .cf-select {
    width: 100%;
    padding: 14px 18px;
    font-size: {{ section.settings.input_font_size }}px;
    color: {{ section.settings.input_text_color }};
    background: {{ section.settings.input_background }};
    border: {{ section.settings.input_border_width }}px solid {{ section.settings.input_border_color }};
    border-radius: {{ section.settings.input_border_radius }}px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    font-family: inherit;
    box-sizing: border-box;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23666666'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 14px center;
    background-size: 18px;
    padding-right: 44px;
    cursor: pointer;
  }

  .cf-select:focus {
    outline: none;
    border-color: {{ section.settings.input_focus_border_color }};
    box-shadow: 0 0 0 3px {{ section.settings.input_focus_shadow_color }};
  }

  /* Pill Button Groups */
  .cf-pill-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .cf-pill {
    padding: 12px 28px;
    font-size: {{ section.settings.pill_font_size }}px;
    font-weight: 500;
    color: {{ section.settings.pill_text_color }};
    background: {{ section.settings.pill_background }};
    border: {{ section.settings.pill_border_width }}px solid {{ section.settings.pill_border_color }};
    border-radius: {{ section.settings.pill_border_radius }}px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
    white-space: nowrap;
    line-height: 1;
  }

  .cf-pill:hover {
    background: {{ section.settings.pill_hover_background }};
    border-color: {{ section.settings.pill_hover_border_color }};
  }

  .cf-pill.active {
    background: {{ section.settings.pill_selected_background }};
    color: {{ section.settings.pill_selected_text_color }};
    border-color: {{ section.settings.pill_selected_border_color }};
  }

  /* Conditional Fields */
  .cf-conditional {
    display: none;
    opacity: 0;
    transform: translateY(-8px);
    transition: opacity 0.35s ease, transform 0.35s ease;
  }

  .cf-conditional.visible {
    display: block;
  }

  .cf-conditional.fade-in {
    opacity: 1;
    transform: translateY(0);
  }

  /* WhatsApp Sub-question */
  .cf-sub-label {
    font-size: {{ section.settings.label_font_size }}px;
    font-weight: {{ section.settings.label_font_weight }};
    color: {{ section.settings.label_color }};
    margin-bottom: 10px;
    display: block;
  }

  /* WhatsApp CTA Button */
  .cf-whatsapp-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 14px 28px;
    background: {{ section.settings.whatsapp_button_background }};
    color: {{ section.settings.whatsapp_button_text_color }};
    font-size: 15px;
    font-weight: 600;
    border-radius: {{ section.settings.button_border_radius }}px;
    text-decoration: none;
    transition: all 0.3s ease;
    font-family: inherit;
    margin-top: 4px;
  }

  .cf-whatsapp-btn:hover {
    background: {{ section.settings.whatsapp_button_hover_background }};
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
  }

  .cf-whatsapp-btn svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  /* Submit Button */
  .cf-submit {
    width: 100%;
    padding: 16px 24px;
    font-size: {{ section.settings.button_font_size }}px;
    font-weight: {{ section.settings.button_font_weight }};
    color: {{ section.settings.button_text_color }};
    background: {{ section.settings.button_background }};
    border: none;
    border-radius: {{ section.settings.button_border_radius }}px;
    cursor: pointer;
    transition: all 0.3s ease;
    letter-spacing: 0.5px;
    margin-top: 8px;
    font-family: inherit;
  }

  .cf-submit:hover {
    background: {{ section.settings.button_hover_background }};
    transform: translateY(-2px);
    box-shadow: 0 4px 12px {{ section.settings.button_shadow_color }};
  }

  .cf-submit:active {
    transform: translateY(0);
  }

  .cf-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  /* Privacy Note */
  .cf-privacy-note {
    text-align: center;
    margin-top: 16px;
    font-size: {{ section.settings.privacy_font_size }}px;
    color: {{ section.settings.privacy_text_color }};
    line-height: 1.5;
  }

  /* Hidden inputs */
  .cf-hidden {
    display: none;
  }

  /* Success/Error Messages */
  .cf-message {
    padding: 16px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
    text-align: center;
  }

  .cf-message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .cf-message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  /* Responsive */
  @media screen and (max-width: 768px) {
    .consultation-form-section {
      padding: 30px 16px;
    }

    .consultation-form-container {
      padding: 28px 22px;
    }

    .cf-heading {
      font-size: {{ section.settings.heading_font_size | times: 0.82 | round }}px;
    }

    .cf-subheading {
      font-size: {{ section.settings.subheading_font_size | times: 0.92 | round }}px;
    }

    .cf-priority-banner-text {
      font-size: {{ section.settings.banner_font_size | times: 0.9 | round }}px;
    }

    .cf-pill {
      padding: 10px 22px;
      font-size: {{ section.settings.pill_font_size | times: 0.92 | round }}px;
    }

    .cf-submit {
      padding: 14px 20px;
      font-size: {{ section.settings.button_font_size | times: 0.92 | round }}px;
    }
  }

  @media screen and (max-width: 480px) {
    .consultation-form-container {
      padding: 22px 18px;
    }

    .cf-pill {
      flex: 1;
      min-width: calc(33% - 10px);
      text-align: center;
      justify-content: center;
    }

    .cf-whatsapp-btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>

<section class="consultation-form-section" id="cf-{{ section.id }}">
  <div class="consultation-form-container">

    {% comment %} Priority Banner {% endcomment %}
    {% if section.settings.show_priority_banner %}
      <div class="cf-priority-banner">
        <span class="cf-priority-banner-text">
          <strong>{{ section.settings.banner_highlight_text }}</strong> {{ section.settings.banner_text }}
        </span>
      </div>
    {% endif %}

    {% comment %} Heading {% endcomment %}
    {% if section.settings.form_heading != blank %}
      <h2 class="cf-heading">{{ section.settings.form_heading }}</h2>
    {% endif %}
    {% if section.settings.form_subheading != blank %}
      <p class="cf-subheading">{{ section.settings.form_subheading }}</p>
    {% endif %}

    {% comment %} Contact Form {% endcomment %}
    {%- form 'contact', id: 'cf-form', class: 'cf-form' -%}

      {%- if form.posted_successfully? -%}
        <div class="cf-message success">
          {{ section.settings.success_message }}
        </div>
      {%- endif -%}

      {%- if form.errors -%}
        <div class="cf-message error">
          {{ form.errors.translated_fields[form.errors.first] | capitalize }} {{ form.errors.messages[form.errors.first] }}
        </div>
      {%- endif -%}

      {% comment %} ===== TREATMENT / SERVICE (pre-selected) ===== {% endcomment %}
      {% if section.settings.show_treatment_field %}
        {%- liquid
          if product.title != blank
            assign preselected_treatment = product.title
          else
            assign preselected_treatment = section.settings.default_treatment_value
          endif
        -%}
        <div class="cf-group">
          <label class="cf-label" for="cf-treatment-{{ section.id }}">
            {{ section.settings.treatment_label }}
          </label>
          <input
            type="text"
            class="cf-input cf-input-preselected"
            id="cf-treatment-{{ section.id }}"
            name="contact[note]"
            value="{{ preselected_treatment }}"
            readonly>
        </div>
      {% endif %}

      {% comment %} ===== NAME ===== {% endcomment %}
      <div class="cf-group">
        <label class="cf-label" for="cf-name-{{ section.id }}">
          {{ section.settings.name_label }}
        </label>
        <input
          type="text"
          class="cf-input"
          id="cf-name-{{ section.id }}"
          name="contact[first_name]"
          placeholder="{{ section.settings.name_placeholder }}"
          autocomplete="name"
          required>
      </div>

      {% comment %} ===== EMAIL (always visible) ===== {% endcomment %}
      <div class="cf-group">
        <label class="cf-label" for="cf-email-{{ section.id }}">
          {{ section.settings.email_label }}
        </label>
        <input
          type="email"
          class="cf-input"
          id="cf-email-{{ section.id }}"
          name="contact[email]"
          placeholder="{{ section.settings.email_placeholder }}"
          autocomplete="email"
          required>
      </div>

      {% comment %} ===== PREFERRED CONTACT METHOD ===== {% endcomment %}
      <div class="cf-group">
        <label class="cf-label">{{ section.settings.contact_method_label }}</label>
        <div class="cf-pill-group" id="cf-method-pills-{{ section.id }}">
          {% assign method_options = section.settings.contact_method_options | split: ',' %}
          {% for option in method_options %}
            {% assign opt = option | strip %}
            <button type="button" class="cf-pill" data-method="{{ opt | downcase }}">{{ opt }}</button>
          {% endfor %}
        </div>
        <input type="hidden" name="contact[subject]" id="cf-method-value-{{ section.id }}" value="">
      </div>

      {% comment %} ===== WHATSAPP CONDITIONAL ===== {% endcomment %}
      <div class="cf-conditional" id="cf-whatsapp-block-{{ section.id }}" data-method="whatsapp">
        <div class="cf-group">
          <span class="cf-sub-label">{{ section.settings.whatsapp_sub_label }}</span>
          <div class="cf-pill-group" id="cf-wa-pills-{{ section.id }}">
            <button type="button" class="cf-pill" data-wa="you-contact">{{ section.settings.wa_you_contact_text }}</button>
            <button type="button" class="cf-pill" data-wa="we-contact">{{ section.settings.wa_we_contact_text }}</button>
          </div>
        </div>

        {% comment %} WhatsApp > You contact us {% endcomment %}
        <div class="cf-conditional" id="cf-wa-you-{{ section.id }}" data-wa-sub="you-contact">
          <div class="cf-group">
            <a
              href="https://wa.me/{{ section.settings.whatsapp_number }}?text={{ section.settings.whatsapp_prefilled_message | url_encode }}"
              target="_blank"
              rel="noopener noreferrer"
              class="cf-whatsapp-btn">
              <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
              </svg>
              {{ section.settings.whatsapp_button_text }}
            </a>
          </div>
        </div>

        {% comment %} WhatsApp > We contact you {% endcomment %}
        <div class="cf-conditional" id="cf-wa-we-{{ section.id }}" data-wa-sub="we-contact">
          <div class="cf-group">
            <input
              type="tel"
              class="cf-input"
              id="cf-wa-phone-{{ section.id }}"
              name="contact[phone]"
              placeholder="{{ section.settings.phone_placeholder }}"
              autocomplete="tel">
          </div>
        </div>
      </div>

      {% comment %} ===== CALL CONDITIONAL ===== {% endcomment %}
      <div class="cf-conditional" id="cf-call-block-{{ section.id }}" data-method="call">
        <div class="cf-group">
          <label class="cf-label" for="cf-call-phone-{{ section.id }}">
            {{ section.settings.call_phone_label }}
          </label>
          <input
            type="tel"
            class="cf-input"
            id="cf-call-phone-{{ section.id }}"
            name="contact[phone]"
            placeholder="{{ section.settings.phone_placeholder }}"
            autocomplete="tel">
        </div>
        <div class="cf-group">
          <label class="cf-label" for="cf-call-time-{{ section.id }}">
            {{ section.settings.call_time_label }}
          </label>
          <select
            class="cf-select"
            id="cf-call-time-{{ section.id }}"
            name="contact[company]">
            <option value="" disabled selected>{{ section.settings.call_time_placeholder }}</option>
            {% assign time_options = section.settings.call_time_options | split: ',' %}
            {% for option in time_options %}
              {% assign opt = option | strip %}
              <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      {% comment %} ===== OPTIONAL MESSAGE ===== {% endcomment %}
      {% if section.settings.show_message_field %}
        <div class="cf-group">
          <label class="cf-label" for="cf-message-{{ section.id }}">
            {{ section.settings.message_label }}
          </label>
          <textarea
            class="cf-textarea"
            id="cf-message-{{ section.id }}"
            name="contact[body]"
            placeholder="{{ section.settings.message_placeholder }}"></textarea>
        </div>
      {% endif %}

      {% comment %} Hidden field to store contact path for the notification email {% endcomment %}
      <input type="hidden" name="contact[company]" id="cf-contact-path-{{ section.id }}" value="">

      {% comment %} ===== SUBMIT ===== {% endcomment %}
      <button type="submit" class="cf-submit" id="cf-submit-{{ section.id }}">
        {{ section.settings.button_text }}
      </button>

    {%- endform -%}

    {% comment %} Privacy Note {% endcomment %}
    {% if section.settings.privacy_note != blank %}
      <p class="cf-privacy-note">{{ section.settings.privacy_note }}</p>
    {% endif %}

  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const S = document.getElementById('cf-{{ section.id }}');
  if (!S) return;

  const methodPills = S.querySelector('#cf-method-pills-{{ section.id }}');
  const methodValue = S.querySelector('#cf-method-value-{{ section.id }}');
  const contactPath = S.querySelector('#cf-contact-path-{{ section.id }}');

  const whatsappBlock = S.querySelector('#cf-whatsapp-block-{{ section.id }}');
  const callBlock = S.querySelector('#cf-call-block-{{ section.id }}');

  const waPills = S.querySelector('#cf-wa-pills-{{ section.id }}');
  const waYouBlock = S.querySelector('#cf-wa-you-{{ section.id }}');
  const waWeBlock = S.querySelector('#cf-wa-we-{{ section.id }}');

  let selectedMethod = '';
  let selectedWaOption = '';
  const hideTimers = new Map();

  /* ---- Utility: show/hide with fade ---- */
  function showBlock(el) {
    if (!el) return;
    /* Cancel any pending hide */
    if (hideTimers.has(el)) {
      clearTimeout(hideTimers.get(el));
      hideTimers.delete(el);
    }
    el.classList.add('visible');
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        el.classList.add('fade-in');
      });
    });
  }

  function hideBlock(el, instant) {
    if (!el) return;
    /* Cancel any pending hide */
    if (hideTimers.has(el)) {
      clearTimeout(hideTimers.get(el));
      hideTimers.delete(el);
    }
    el.classList.remove('fade-in');
    if (instant) {
      el.classList.remove('visible');
    } else {
      const timer = setTimeout(() => {
        el.classList.remove('visible');
        hideTimers.delete(el);
      }, 350);
      hideTimers.set(el, timer);
    }
  }

  function hideAllMethodBlocks() {
    [whatsappBlock, callBlock].forEach(el => hideBlock(el, true));
    hideAllWaSubs();
    selectedWaOption = '';
    if (waPills) {
      waPills.querySelectorAll('.cf-pill').forEach(p => p.classList.remove('active'));
    }
  }

  function hideAllWaSubs() {
    [waYouBlock, waWeBlock].forEach(el => hideBlock(el, true));
  }

  /* ---- Clear dynamic required / values ---- */
  function clearConditionalInputs() {
    /* Remove required from ALL conditional inputs */
    const waPhone = S.querySelector('#cf-wa-phone-{{ section.id }}');
    const callPhone = S.querySelector('#cf-call-phone-{{ section.id }}');
    const callTime = S.querySelector('#cf-call-time-{{ section.id }}');
    [waPhone, callPhone, callTime].forEach(input => {
      if (input) {
        input.removeAttribute('required');
        input.value = '';
        input.style.borderColor = '';
      }
    });
    /* Reset call time dropdown */
    if (callTime) callTime.selectedIndex = 0;
  }

  function setRequired(selector) {
    const el = S.querySelector(selector);
    if (el) el.setAttribute('required', '');
  }

  /* ---- Update the hidden contact path summary ---- */
  function updateContactPath() {
    let path = selectedMethod;
    if (selectedMethod.includes('whatsapp') && selectedWaOption) {
      path += ' > ' + selectedWaOption;
    }
    if (contactPath) contactPath.value = path;
  }

  /* ---- CONTACT METHOD PILLS ---- */
  if (methodPills) {
    methodPills.querySelectorAll('.cf-pill').forEach(pill => {
      pill.addEventListener('click', function(e) {
        e.preventDefault();
        const method = this.dataset.method;

        /* Toggle off if same pill clicked */
        if (selectedMethod === method) return;

        /* Update UI */
        methodPills.querySelectorAll('.cf-pill').forEach(p => p.classList.remove('active'));
        this.classList.add('active');

        /* Hide previous, clear inputs */
        hideAllMethodBlocks();
        clearConditionalInputs();

        selectedMethod = method;
        if (methodValue) methodValue.value = this.textContent.trim();

        /* Show relevant block and set required on its fields */
        if (method.includes('whatsapp')) {
          showBlock(whatsappBlock);
        } else if (method.includes('call')) {
          showBlock(callBlock);
          setRequired('#cf-call-phone-{{ section.id }}');
          setRequired('#cf-call-time-{{ section.id }}');
        }

        updateContactPath();
      });
    });
  }

  /* ---- WHATSAPP SUB-PILLS ---- */
  if (waPills) {
    waPills.querySelectorAll('.cf-pill').forEach(pill => {
      pill.addEventListener('click', function(e) {
        e.preventDefault();
        const waOption = this.dataset.wa;

        if (selectedWaOption === waOption) return;

        waPills.querySelectorAll('.cf-pill').forEach(p => p.classList.remove('active'));
        this.classList.add('active');

        hideAllWaSubs();

        /* Clear wa-specific required */
        const waPhone = S.querySelector('#cf-wa-phone-{{ section.id }}');
        if (waPhone) {
          waPhone.removeAttribute('required');
          waPhone.value = '';
        }

        selectedWaOption = waOption;

        if (waOption === 'you-contact') {
          showBlock(waYouBlock);
        } else if (waOption === 'we-contact') {
          showBlock(waWeBlock);
          setRequired('#cf-wa-phone-{{ section.id }}');
        }

        updateContactPath();
      });
    });
  }

  /* ---- FORM VALIDATION ---- */
  const form = S.querySelector('.cf-form') || S.querySelector('#cf-form') || S.querySelector('form');
  const submitBtn = S.querySelector('#cf-submit-{{ section.id }}');

  function handleValidation(e) {
      /* Helper: check required fields are filled */
      function validateCoreFields() {
        const name = S.querySelector('#cf-name-{{ section.id }}');
        const email = S.querySelector('#cf-email-{{ section.id }}');
        let valid = true;

        if (name) {
          name.value = name.value.trim();
          if (!name.value) {
            name.style.borderColor = '#dc3545';
            name.focus();
            valid = false;
          } else {
            name.style.borderColor = '';
          }
        }

        if (email) {
          email.value = email.value.trim();
          if (!email.value || !email.checkValidity()) {
            email.style.borderColor = '#dc3545';
            if (valid) email.focus();
            valid = false;
          } else {
            email.style.borderColor = '';
          }
        }

        return valid;
      }

      /* Must have selected a contact method */
      if (!selectedMethod) {
        e.preventDefault();
        methodPills.style.outline = '2px solid #dc3545';
        methodPills.style.outlineOffset = '4px';
        methodPills.style.borderRadius = '8px';
        return false;
      }

      /* Call — validate phone + time */
      if (selectedMethod.includes('call')) {
        if (!validateCoreFields()) {
          e.preventDefault();
          return false;
        }
        const callPhone = S.querySelector('#cf-call-phone-{{ section.id }}');
        const callTime = S.querySelector('#cf-call-time-{{ section.id }}');
        if (callPhone) {
          callPhone.value = callPhone.value.trim();
          if (!callPhone.value || callPhone.value.length < 5) {
            e.preventDefault();
            callPhone.style.borderColor = '#dc3545';
            callPhone.value = '';
            callPhone.focus();
            return false;
          }
        }
        if (callTime && !callTime.value) {
          e.preventDefault();
          callTime.style.borderColor = '#dc3545';
          callTime.focus();
          return false;
        }
        return true;
      }

      /* WhatsApp requires a sub-selection */
      if (selectedMethod.includes('whatsapp') && !selectedWaOption) {
        e.preventDefault();
        waPills.style.outline = '2px solid #dc3545';
        waPills.style.outlineOffset = '4px';
        waPills.style.borderRadius = '8px';
        return false;
      }

      /* WhatsApp > "You contact us" — validate core fields, submit form, then open WhatsApp */
      if (selectedMethod.includes('whatsapp') && selectedWaOption === 'you-contact') {
        if (!validateCoreFields()) {
          e.preventDefault();
          return false;
        }
        /* Let form submit normally, then open WhatsApp link */
        setTimeout(() => {
          const waLink = S.querySelector('.cf-whatsapp-btn');
          if (waLink) window.open(waLink.href, '_blank');
        }, 100);
        return true;
      }

      /* WhatsApp > "Message me" — validate core fields + phone required */
      if (selectedMethod.includes('whatsapp') && selectedWaOption === 'we-contact') {
        if (!validateCoreFields()) {
          e.preventDefault();
          return false;
        }
        const waPhone = S.querySelector('#cf-wa-phone-{{ section.id }}');
        if (waPhone) {
          waPhone.value = waPhone.value.trim();
          if (!waPhone.value || waPhone.value.length < 5) {
            e.preventDefault();
            waPhone.style.borderColor = '#dc3545';
            waPhone.value = '';
            waPhone.focus();
            return false;
          }
        }
        return true;
      }

      /* Default: validate core fields */
      if (!validateCoreFields()) {
        e.preventDefault();
        return false;
      }
      return true;
  }

  if (form) {
    form.addEventListener('submit', handleValidation);
  }

  /* Backup: also intercept submit button click */
  if (submitBtn) {
    submitBtn.addEventListener('click', function(e) {
      if (!form) return;
      const isValid = handleValidation(e);
      if (!isValid) {
        e.preventDefault();
        e.stopPropagation();
      }
    });
  }

  /* Clear validation outlines on pill click */
  S.querySelectorAll('.cf-pill').forEach(btn => {
    btn.addEventListener('click', function() {
      const group = this.closest('.cf-pill-group');
      if (group) group.style.outline = 'none';
    });
  });

  /* Clear red border on inputs when user starts typing/selecting */
  S.querySelectorAll('.cf-input, .cf-textarea, .cf-select').forEach(input => {
    input.addEventListener('input', function() {
      this.style.borderColor = '';
    });
    input.addEventListener('change', function() {
      this.style.borderColor = '';
    });
  });
});
</script>

{% schema %}
{
  "name": "Consultation Form",
  "tag": "section",
  "class": "consultation-form-wrapper",
  "settings": [
    {
      "type": "header",
      "content": "Section Layout"
    },
    {
      "type": "range",
      "id": "section_width",
      "label": "Section Width",
      "min": 800,
      "max": 1600,
      "step": 50,
      "default": 1200,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "section_padding_top",
      "label": "Top Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 50,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "section_padding_bottom",
      "label": "Bottom Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 50,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "section_padding_side",
      "label": "Side Padding",
      "min": 15,
      "max": 60,
      "step": 5,
      "default": 20,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "section_background",
      "label": "Section Background",
      "default": "#f5f2ed"
    },
    {
      "type": "header",
      "content": "Form Container"
    },
    {
      "type": "range",
      "id": "form_max_width",
      "label": "Form Max Width",
      "min": 400,
      "max": 900,
      "step": 25,
      "default": 600,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "form_background",
      "label": "Form Background",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "form_border_radius",
      "label": "Form Border Radius",
      "min": 0,
      "max": 30,
      "step": 2,
      "default": 16,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "form_padding",
      "label": "Form Padding",
      "min": 20,
      "max": 60,
      "step": 5,
      "default": 40,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "form_shadow",
      "label": "Form Shadow",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "0 2px 8px rgba(0,0,0,0.06)", "label": "Subtle" },
        { "value": "0 4px 20px rgba(0,0,0,0.08)", "label": "Medium" },
        { "value": "0 8px 30px rgba(0,0,0,0.12)", "label": "Strong" }
      ],
      "default": "0 4px 20px rgba(0,0,0,0.08)"
    },
    {
      "type": "header",
      "content": "Priority Banner"
    },
    {
      "type": "checkbox",
      "id": "show_priority_banner",
      "label": "Show Priority Banner",
      "default": true
    },
    {
      "type": "text",
      "id": "banner_highlight_text",
      "label": "Banner Highlight Text",
      "default": "Priority Response Guarantee:"
    },
    {
      "type": "text",
      "id": "banner_text",
      "label": "Banner Text",
      "default": "We will contact you within 24 hours."
    },
    {
      "type": "color",
      "id": "banner_text_color",
      "label": "Banner Text Color",
      "default": "#777777"
    },
    {
      "type": "color",
      "id": "banner_highlight_color",
      "label": "Banner Highlight Color",
      "default": "#8a7544"
    },
    {
      "type": "range",
      "id": "banner_font_size",
      "label": "Banner Font Size",
      "min": 12,
      "max": 18,
      "step": 1,
      "default": 14,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Heading"
    },
    {
      "type": "text",
      "id": "form_heading",
      "label": "Form Heading",
      "default": "Request Your Consultation"
    },
    {
      "type": "text",
      "id": "form_subheading",
      "label": "Form Subheading",
      "default": "Fill out the form below and we'll guide you to the best next step."
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#1a1a1a"
    },
    {
      "type": "range",
      "id": "heading_font_size",
      "label": "Heading Font Size",
      "min": 20,
      "max": 42,
      "step": 2,
      "default": 30,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "heading_font_weight",
      "label": "Heading Font Weight",
      "options": [
        { "value": "400", "label": "Normal" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semi Bold" },
        { "value": "700", "label": "Bold" }
      ],
      "default": "600"
    },
    {
      "type": "color",
      "id": "subheading_color",
      "label": "Subheading Color",
      "default": "#777777"
    },
    {
      "type": "range",
      "id": "subheading_font_size",
      "label": "Subheading Font Size",
      "min": 13,
      "max": 20,
      "step": 1,
      "default": 15,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Labels"
    },
    {
      "type": "color",
      "id": "label_color",
      "label": "Label Color",
      "default": "#1a1a1a"
    },
    {
      "type": "range",
      "id": "label_font_size",
      "label": "Label Font Size",
      "min": 13,
      "max": 18,
      "step": 1,
      "default": 15,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "label_font_weight",
      "label": "Label Font Weight",
      "options": [
        { "value": "400", "label": "Normal" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semi Bold" }
      ],
      "default": "500"
    },
    {
      "type": "header",
      "content": "Input Fields"
    },
    {
      "type": "color",
      "id": "input_background",
      "label": "Input Background",
      "default": "#f8f7f5"
    },
    {
      "type": "color",
      "id": "input_border_color",
      "label": "Input Border Color",
      "default": "#e5e2dc"
    },
    {
      "type": "range",
      "id": "input_border_width",
      "label": "Input Border Width",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 1,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "input_border_radius",
      "label": "Input Border Radius",
      "min": 0,
      "max": 16,
      "step": 2,
      "default": 8,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "input_text_color",
      "label": "Input Text Color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "input_placeholder_color",
      "label": "Input Placeholder Color",
      "default": "#aaaaaa"
    },
    {
      "type": "range",
      "id": "input_font_size",
      "label": "Input Font Size",
      "min": 13,
      "max": 18,
      "step": 1,
      "default": 15,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "input_focus_border_color",
      "label": "Input Focus Border Color",
      "default": "#b8a164"
    },
    {
      "type": "color",
      "id": "input_focus_shadow_color",
      "label": "Input Focus Shadow Color",
      "default": "rgba(184, 161, 100, 0.15)"
    },
    {
      "type": "header",
      "content": "Treatment / Service Field"
    },
    {
      "type": "checkbox",
      "id": "show_treatment_field",
      "label": "Show Treatment Field",
      "default": true
    },
    {
      "type": "text",
      "id": "treatment_label",
      "label": "Treatment Field Label",
      "default": "Treatment"
    },
    {
      "type": "text",
      "id": "default_treatment_value",
      "label": "Default Value (non-product pages)",
      "default": "General Consultation",
      "info": "On product pages this auto-fills with the product title. On other pages it uses this value."
    },
    {
      "type": "color",
      "id": "preselected_background",
      "label": "Pre-selected Background",
      "default": "#f5f4f1"
    },
    {
      "type": "color",
      "id": "preselected_text_color",
      "label": "Pre-selected Text Color",
      "default": "#555555"
    },
    {
      "type": "header",
      "content": "Name Field"
    },
    {
      "type": "text",
      "id": "name_label",
      "label": "Name Label",
      "default": "Name"
    },
    {
      "type": "text",
      "id": "name_placeholder",
      "label": "Name Placeholder",
      "default": "Your Name"
    },
    {
      "type": "header",
      "content": "Contact Method"
    },
    {
      "type": "text",
      "id": "contact_method_label",
      "label": "Contact Method Label",
      "default": "Preferred contact method"
    },
    {
      "type": "text",
      "id": "contact_method_options",
      "label": "Contact Method Options",
      "default": "WhatsApp, Call",
      "info": "Comma-separated values. WhatsApp and Call have built-in conditional logic."
    },
    {
      "type": "header",
      "content": "Email Field"
    },
    {
      "type": "text",
      "id": "email_label",
      "label": "Email Label",
      "default": "Email Address"
    },
    {
      "type": "text",
      "id": "email_placeholder",
      "label": "Email Placeholder",
      "default": "Email Address"
    },
    {
      "type": "header",
      "content": "WhatsApp Settings"
    },
    {
      "type": "text",
      "id": "whatsapp_number",
      "label": "WhatsApp Number (with country code, no +)",
      "default": "447798983387",
      "info": "Example: 447798983387 for a UK number"
    },
    {
      "type": "text",
      "id": "whatsapp_sub_label",
      "label": "WhatsApp Sub-question",
      "default": "How would you like to connect on WhatsApp?"
    },
    {
      "type": "text",
      "id": "wa_you_contact_text",
      "label": "\"You contact us\" button text",
      "default": "I'll message you"
    },
    {
      "type": "text",
      "id": "wa_we_contact_text",
      "label": "\"We contact you\" button text",
      "default": "Message me"
    },
    {
      "type": "text",
      "id": "whatsapp_button_text",
      "label": "WhatsApp CTA Button Text",
      "default": "Chat on WhatsApp"
    },
    {
      "type": "textarea",
      "id": "whatsapp_prefilled_message",
      "label": "WhatsApp Pre-filled Message",
      "default": "Hi! I'd like to book a consultation please."
    },
    {
      "type": "color",
      "id": "whatsapp_button_background",
      "label": "WhatsApp Button Background",
      "default": "#25D366"
    },
    {
      "type": "color",
      "id": "whatsapp_button_hover_background",
      "label": "WhatsApp Button Hover Background",
      "default": "#1fbe59"
    },
    {
      "type": "color",
      "id": "whatsapp_button_text_color",
      "label": "WhatsApp Button Text Color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Phone / Call Settings"
    },
    {
      "type": "text",
      "id": "clinic_phone_number",
      "label": "Clinic Phone Number",
      "default": "01902256667",
      "info": "Shown as a clickable call button when Call is selected"
    },
    {
      "type": "text",
      "id": "call_phone_label",
      "label": "Call Phone Label",
      "default": "Your phone number"
    },
    {
      "type": "text",
      "id": "call_time_label",
      "label": "Call Time Label",
      "default": "Best time to call you?"
    },
    {
      "type": "text",
      "id": "call_time_placeholder",
      "label": "Call Time Placeholder",
      "default": "Select a time"
    },
    {
      "type": "text",
      "id": "call_time_options",
      "label": "Call Time Options",
      "default": "Morning (9am-12pm), Afternoon (12pm-5pm), Evening (5pm-8pm)",
      "info": "Comma-separated values"
    },
    {
      "type": "text",
      "id": "phone_placeholder",
      "label": "Phone Placeholder",
      "default": "Phone Number"
    },
    {
      "type": "header",
      "content": "Pill Button Styling"
    },
    {
      "type": "color",
      "id": "pill_background",
      "label": "Pill Background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "pill_text_color",
      "label": "Pill Text Color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "pill_border_color",
      "label": "Pill Border Color",
      "default": "#d5d0c8"
    },
    {
      "type": "range",
      "id": "pill_border_width",
      "label": "Pill Border Width",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 1,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "pill_border_radius",
      "label": "Pill Border Radius",
      "min": 4,
      "max": 30,
      "step": 2,
      "default": 24,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "pill_font_size",
      "label": "Pill Font Size",
      "min": 13,
      "max": 18,
      "step": 1,
      "default": 15,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "pill_hover_background",
      "label": "Pill Hover Background",
      "default": "#f8f7f5"
    },
    {
      "type": "color",
      "id": "pill_hover_border_color",
      "label": "Pill Hover Border Color",
      "default": "#b8a164"
    },
    {
      "type": "color",
      "id": "pill_selected_background",
      "label": "Pill Selected Background",
      "default": "#3a3a3a"
    },
    {
      "type": "color",
      "id": "pill_selected_text_color",
      "label": "Pill Selected Text Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "pill_selected_border_color",
      "label": "Pill Selected Border Color",
      "default": "#3a3a3a"
    },
    {
      "type": "header",
      "content": "Message Field"
    },
    {
      "type": "checkbox",
      "id": "show_message_field",
      "label": "Show Message Field",
      "default": true
    },
    {
      "type": "text",
      "id": "message_label",
      "label": "Message Label",
      "default": "Anything you want us to know?"
    },
    {
      "type": "text",
      "id": "message_placeholder",
      "label": "Message Placeholder",
      "default": "Optional"
    },
    {
      "type": "header",
      "content": "Submit Button"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Request Consultation"
    },
    {
      "type": "color",
      "id": "button_background",
      "label": "Button Background",
      "default": "#3a3a3a"
    },
    {
      "type": "color",
      "id": "button_hover_background",
      "label": "Button Hover Background",
      "default": "#2a2a2a"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "button_font_size",
      "label": "Button Font Size",
      "min": 14,
      "max": 20,
      "step": 1,
      "default": 15,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "button_font_weight",
      "label": "Button Font Weight",
      "options": [
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semi Bold" },
        { "value": "700", "label": "Bold" }
      ],
      "default": "700"
    },
    {
      "type": "range",
      "id": "button_border_radius",
      "label": "Button Border Radius",
      "min": 0,
      "max": 30,
      "step": 2,
      "default": 8,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "button_shadow_color",
      "label": "Button Hover Shadow Color",
      "default": "rgba(0, 0, 0, 0.15)"
    },
    {
      "type": "header",
      "content": "Success Message"
    },
    {
      "type": "text",
      "id": "success_message",
      "label": "Success Message",
      "default": "Thank you! We'll be in touch within 24 hours."
    },
    {
      "type": "header",
      "content": "Privacy Note"
    },
    {
      "type": "text",
      "id": "privacy_note",
      "label": "Privacy Note",
      "default": "100% private. No spam. We only contact you using the method you selected."
    },
    {
      "type": "color",
      "id": "privacy_text_color",
      "label": "Privacy Note Color",
      "default": "#999999"
    },
    {
      "type": "range",
      "id": "privacy_font_size",
      "label": "Privacy Note Font Size",
      "min": 11,
      "max": 16,
      "step": 1,
      "default": 13,
      "unit": "px"
    }
  ],
  "presets": [
    {
      "name": "Consultation Form"
    }
  ]
}
{% endschema %}