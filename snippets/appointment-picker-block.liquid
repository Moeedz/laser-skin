<div class="product-appointment-picker">
    <style>
      .product-appointment-picker {
        margin: 20px 0;
      }
      .appointment-selector-label {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
        display: block;
        color: #333;
      }
      .appointment-dropdown {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        font-size: 14px;
        color: #333;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.2s;
      }
      .appointment-dropdown:hover {
        border-color: #999;
      }
      .appointment-dropdown-icon {
        transition: transform 0.3s;
      }
      .appointment-dropdown.active .appointment-dropdown-icon {
        transform: rotate(180deg);
      }
      .appointment-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        align-items: center;
        justify-content: center;
      }
      .appointment-modal.active {
        display: flex;
      }
      .appointment-modal-content {
        background: white;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
      }
      .appointment-modal-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .appointment-modal-title {
        font-size: 18px;
        font-weight: 600;
      }
      .appointment-modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
      }
      .appointment-modal-body {
        padding: 20px;
      }
      .calendar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
      }
      .calendar-nav-btn {
        background: #f5f5f5;
        border: 1px solid #e0e0e0;
        cursor: pointer;
        padding: 8px 12px;
        font-size: 20px;
        border-radius: 4px;
        min-width: 40px;
      }
      .calendar-month-year {
        font-size: 16px;
        font-weight: 700;
      }
      .calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-bottom: 8px;
      }
      .calendar-weekday {
        text-align: center;
        font-size: 12px;
        font-weight: 600;
        color: #666;
        padding: 4px 0;
      }
      .calendar-dates {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-bottom: 24px;
      }
      .calendar-date {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border-radius: 50%;
        transition: all 0.2s;
        border: 2px solid transparent;
        min-height: 40px;
      }
      .calendar-date:hover:not(.disabled):not(.past) {
        background: #f5f5f5;
      }
      .calendar-date.selected {
        background: #10B981;
        color: white;
      }
      .calendar-date.today {
        border-color: #10B981;
      }
      .calendar-date.disabled {
        color: #ccc;
        cursor: not-allowed;
        text-decoration: line-through;
      }
      .calendar-date.past {
        color: #ccc;
        cursor: not-allowed;
      }
      .time-panel-header {
        background: #2D3748;
        color: white;
        padding: 12px 16px;
        text-align: center;
        font-size: 14px;
        font-weight: 600;
        border-radius: 8px 8px 0 0;
      }
      .time-slots-scroll {
        border: 1px solid #e0e0e0;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 250px;
        overflow-y: auto;
        padding: 8px;
      }
      .time-slot-option {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        margin-bottom: 4px;
        cursor: pointer;
        border-radius: 4px;
      }
      .time-slot-option:hover {
        background: #f5f5f5;
      }
      .time-slot-option.selected {
        background: #E6F7F1;
      }
      .time-slot-radio {
        width: 20px;
        height: 20px;
        border: 2px solid #D1D5DB;
        border-radius: 50%;
        position: relative;
      }
      .time-slot-option.selected .time-slot-radio {
        border-color: #10B981;
      }
      .time-slot-option.selected .time-slot-radio::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 10px;
        height: 10px;
        background: #10B981;
        border-radius: 50%;
      }
      .appointment-modal-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 12px;
      }
      .appointment-btn {
        flex: 1;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
      }
      .appointment-btn-cancel {
        background: #f5f5f5;
        color: #333;
      }
      .appointment-btn-confirm {
        background: #10B981;
        color: white;
      }
      .appointment-btn-confirm:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
    </style>

    <label class="appointment-selector-label">Select Date and Time:</label>
    <div class="appointment-dropdown" id="appointmentDropdown-{{ block.id }}">
      <span id="appointmentDisplay-{{ block.id }}">Choose appointment date and time</span>
      <span class="appointment-dropdown-icon">â–¼</span>
    </div>

    <div class="appointment-modal" id="appointmentModal-{{ block.id }}">
      <div class="appointment-modal-content">
        <div class="appointment-modal-header">
          <div class="appointment-modal-title">ðŸ“… Select Date and Time</div>
          <button class="appointment-modal-close" id="closeModal-{{ block.id }}">&times;</button>
        </div>
        <div class="appointment-modal-body">
          <div class="calendar-header">
            <button type="button" class="calendar-nav-btn" id="prevMonth-{{ block.id }}">â€¹</button>
            <div class="calendar-month-year" id="monthYear-{{ block.id }}"></div>
            <button type="button" class="calendar-nav-btn" id="nextMonth-{{ block.id }}">â€º</button>
          </div>
          <div class="calendar-weekdays">
            <div class="calendar-weekday">Mon</div>
            <div class="calendar-weekday">Tue</div>
            <div class="calendar-weekday">Wed</div>
            <div class="calendar-weekday">Thu</div>
            <div class="calendar-weekday">Fri</div>
            <div class="calendar-weekday">Sat</div>
            <div class="calendar-weekday">Sun</div>
          </div>
          <div class="calendar-dates" id="calendarDates-{{ block.id }}"></div>
          <div class="time-panel-header" id="timeHeader-{{ block.id }}">Select a date first</div>
          <div class="time-slots-scroll" id="timeSlots-{{ block.id }}"></div>
        </div>
        <div class="appointment-modal-footer">
          <button class="appointment-btn appointment-btn-cancel" id="cancelBtn-{{ block.id }}">Cancel</button>
          <button class="appointment-btn appointment-btn-confirm" id="confirmBtn-{{ block.id }}" disabled>Confirm</button>
        </div>
      </div>
    </div>

    <script>
      (function() {
        const blockId = '{{ block.id }}';
        const defaultSlots = `{{ block.settings.default_slots }}`.split('\n').map(s => s.trim()).filter(s => s);
        const saturdaySlots = `{{ block.settings.saturday_slots }}`.split('\n').map(s => s.trim()).filter(s => s);
        const customDatesText = `{{ block.settings.custom_dates }}`;
        
        const CUSTOM_DATES = {};
        if (customDatesText.trim()) {
          customDatesText.split('\n').forEach(line => {
            line = line.trim();
            if (!line) return;
            const [date, slotsStr] = line.split('|');
            if (slotsStr === 'CLOSED') {
              CUSTOM_DATES[date.trim()] = 'CLOSED';
            } else {
              CUSTOM_DATES[date.trim()] = slotsStr.split(',').map(s => s.trim());
            }
          });
        }

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        let selectedTime = null;

        const dropdown = document.getElementById(`appointmentDropdown-${blockId}`);
        const display = document.getElementById(`appointmentDisplay-${blockId}`);
        const modal = document.getElementById(`appointmentModal-${blockId}`);
        const closeBtn = document.getElementById(`closeModal-${blockId}`);
        const cancelBtn = document.getElementById(`cancelBtn-${blockId}`);
        const confirmBtn = document.getElementById(`confirmBtn-${blockId}`);

        dropdown.addEventListener('click', () => {
          modal.classList.add('active');
          renderCalendar();
        });

        function closeModal() {
          modal.classList.remove('active');
        }

        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
          if (e.target === modal) closeModal();
        });

        document.getElementById(`prevMonth-${blockId}`).addEventListener('click', () => {
          currentMonth--;
          if (currentMonth < 0) { currentMonth = 11; currentYear--; }
          renderCalendar();
        });

        document.getElementById(`nextMonth-${blockId}`).addEventListener('click', () => {
          currentMonth++;
          if (currentMonth > 11) { currentMonth = 0; currentYear++; }
          renderCalendar();
        });

        function renderCalendar() {
          const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
          document.getElementById(`monthYear-${blockId}`).textContent = `${months[currentMonth]} ${currentYear}`;
          
          const container = document.getElementById(`calendarDates-${blockId}`);
          container.innerHTML = '';
          
          const firstDay = new Date(currentYear, currentMonth, 1).getDay();
          const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
          const today = new Date();
          today.setHours(0,0,0,0);
          
          const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
          const closedDays = [0, 1, 4];
          
          for (let i = 0; i < adjustedFirstDay; i++) {
            container.innerHTML += '<div class="calendar-date"></div>';
          }
          
          for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentYear, currentMonth, day);
            date.setHours(0,0,0,0);
            const dayOfWeek = date.getDay();
            
            let classes = 'calendar-date';
            if (date < today) classes += ' past';
            else if (closedDays.includes(dayOfWeek)) classes += ' disabled';
            else if (date.getTime() === today.getTime()) classes += ' today';
            if (selectedDate && date.getTime() === selectedDate.getTime()) classes += ' selected';
            
            const dateEl = document.createElement('div');
            dateEl.className = classes;
            dateEl.textContent = day;
            if (!classes.includes('past') && !classes.includes('disabled')) {
              dateEl.addEventListener('click', () => selectDate(date));
            }
            container.appendChild(dateEl);
          }
        }

        function selectDate(date) {
          selectedDate = date;
          selectedTime = null;
          renderCalendar();
          updateTimeSlots(date);
          confirmBtn.disabled = true;
        }

        function updateTimeSlots(date) {
          const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
          const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
          document.getElementById(`timeHeader-${blockId}`).textContent = 
            `${days[date.getDay()]}, ${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
          
          const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
          let slots = [];
          
          if (CUSTOM_DATES[dateStr]) {
            if (CUSTOM_DATES[dateStr] === 'CLOSED') {
              document.getElementById(`timeSlots-${blockId}`).innerHTML = 
                '<div style="padding:20px;text-align:center;color:#999">No appointments available</div>';
              return;
            }
            slots = CUSTOM_DATES[dateStr];
          } else {
            slots = date.getDay() === 6 ? saturdaySlots : defaultSlots;
          }
          
          const container = document.getElementById(`timeSlots-${blockId}`);
          container.innerHTML = '';
          slots.forEach(time => {
            const el = document.createElement('div');
            el.className = 'time-slot-option';
            el.innerHTML = `<span>${time}</span><div class="time-slot-radio"></div>`;
            el.addEventListener('click', () => selectTime(time, el));
            container.appendChild(el);
          });
        }

        function selectTime(time, el) {
          document.querySelectorAll(`#timeSlots-${blockId} .time-slot-option`).forEach(s => s.classList.remove('selected'));
          el.classList.add('selected');
          selectedTime = time;
          confirmBtn.disabled = false;
        }

        confirmBtn.addEventListener('click', () => {
          if (!selectedDate || !selectedTime) return;
          
          const formatted = selectedDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
          display.textContent = `${formatted} at ${selectedTime}`;
          
          const form = document.querySelector('form[action="/cart/add"]');
          if (form) {
            form.querySelectorAll('input[name^="properties[Appointment"]').forEach(i => i.remove());
            
            const dateInput = document.createElement('input');
            dateInput.type = 'hidden';
            dateInput.name = 'properties[Appointment Date]';
            dateInput.value = formatted;
            form.appendChild(dateInput);
            
            const timeInput = document.createElement('input');
            timeInput.type = 'hidden';
            timeInput.name = 'properties[Appointment Time]';
            timeInput.value = selectedTime;
            form.appendChild(timeInput);
          }
          
          closeModal();
        });

        renderCalendar();
      })();
    </script>
  </div>